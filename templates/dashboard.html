	<!DOCTYPE html>
	<html lang="zh">
	<head>
	    <meta charset="UTF-8">
	    <title>ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿ</title>
	    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
	    <style>
	        .log-container { height: 300px; overflow-y: scroll; background: #f8f9fa; padding: 10px; font-family: monospace; font-size: 0.9em; }
	        #taskTable tbody tr:hover { background-color: #f1f1f1; }
	    </style>
	</head>
	<body class="bg-light">
	<div class="container py-4">
	    <div class="d-flex justify-content-between align-items-center mb-4">
	        <h3>âš™ï¸ ä»»åŠ¡è°ƒåº¦ç®¡ç†</h3>
	        <!-- æ–°å¢ï¼šåˆ·æ–°è„šæœ¬æŒ‰é’® -->
	        <button class="btn btn-sm btn-outline-primary" onclick="loadTaskOptions()">
	            ğŸ”„ åˆ·æ–°è„šæœ¬
	        </button>
	    </div>
	    <div class="row">
	        <!-- å·¦ä¾§ï¼šæ·»åŠ ä»»åŠ¡ -->
	        <div class="col-md-4">
	            <div class="card shadow-sm">
	                <div class="card-header bg-primary text-white">æ·»åŠ æ–°ä»»åŠ¡</div>
	                <div class="card-body">
	                    <div class="mb-3">
	                        <label class="form-label">ä»»åŠ¡åç§°</label>
	                        <input type="text" id="taskName" class="form-control" placeholder="è¾“å…¥ä»»åŠ¡æè¿°">
	                    </div>
	                    <div class="mb-3">
	                        <label class="form-label">é€‰æ‹©ä»»åŠ¡è„šæœ¬</label>
	                        <select id="funcName" class="form-select">
	                            <option value="">åŠ è½½ä¸­...</option>
	                        </select>
	                    </div>
	                    <div class="mb-3">
	                        <label class="form-label">è§¦å‘ç±»å‹</label>
	                        <select id="triggerType" class="form-select" onchange="updateTriggerPlaceholder()">
	                            <option value="interval">é—´éš”æ‰§è¡Œ</option>
	                            <option value="cron">å®šæ—¶æ‰§è¡Œ</option>
	                            <option value="date">å•æ¬¡æ‰§è¡Œ</option>
	                        </select>
	                    </div>
	                    <div class="mb-3">
	                        <label class="form-label">è§¦å‘å‚æ•° (JSON)</label>
	                        <textarea id="triggerArgs" class="form-control font-monospace" rows="3" placeholder='{"seconds": 10}'></textarea>
	                        <div class="form-text">ä¾‹å¦‚: interval -> {"seconds": 10}, cron -> {"hour": 14, "minute": 30}</div>
	                    </div>
	                    <button class="btn btn-primary w-100" onclick="addTask()">æ·»åŠ ä»»åŠ¡</button>
	                </div>
	            </div>
	        </div>
	        <!-- å³ä¾§ï¼šä»»åŠ¡åˆ—è¡¨ -->
	        <div class="col-md-8">
	            <div class="card shadow-sm">
	                <div class="card-header bg-secondary text-white">å½“å‰ä»»åŠ¡åˆ—è¡¨</div>
	                <div class="card-body">
	                    <table class="table table-striped table-hover" id="taskTable">
	                        <thead>
	                            <tr>
	                                <th>ID</th>
	                                <th>åç§°</th>
	                                <th>ä¸‹æ¬¡è¿è¡Œæ—¶é—´</th>
	                                <th>æ“ä½œ</th>
	                            </tr>
	                        </thead>
	                        <tbody>
	                            <!-- åŠ¨æ€å†…å®¹ -->
	                        </tbody>
	                    </table>
	                </div>
	            </div>
	        </div>
	    </div>
	    <div class="row mt-4">
	        <div class="col-12">
	            <div class="card shadow-sm">
	                <div class="card-header bg-dark text-white">æ‰§è¡Œæ—¥å¿—</div>
	                <div class="card-body log-container" id="logContainer">
	                    <!-- æ—¥å¿—å†…å®¹ -->
	                </div>
	            </div>
	        </div>
	    </div>
	</div>
	<script>
	    // 1. åŠ è½½ä»»åŠ¡ä¸‹æ‹‰æ¡†ï¼ˆå¸¦çƒ­åŠ è½½é€»è¾‘ï¼‰
	    async function loadTaskOptions() {
	        const btn = document.querySelector('button[onclick="loadTaskOptions()"]');
	        if(btn) btn.innerHTML = 'â³ åŠ è½½ä¸­...';
	        try {
	            const res = await fetch('/api/tasks/list');
	            const json = await res.json();
	            const select = document.getElementById('funcName');
	            select.innerHTML = ''; // æ¸…ç©º
	            if(json.code === 0) {
	                if(json.data.length === 0) {
	                    const opt = document.createElement('option');
	                    opt.text = "æš‚æ— è„šæœ¬";
	                    select.appendChild(opt);
	                } else {
	                    json.data.forEach(item => {
	                        const option = document.createElement('option');
	                        option.value = item.func_name;
	                        option.text = item.display_name;
	                        select.appendChild(option);
	                    });
	                }
	                console.log(`[ç³»ç»Ÿ] å·²åˆ·æ–° ${json.data.length} ä¸ªè„šæœ¬`);
	            } else {
	                alert(json.message);
	            }
	        } catch(e) {
	            console.error("åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥", e);
	            alert('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥');
	        } finally {
	            if(btn) btn.innerHTML = 'ğŸ”„ åˆ·æ–°è„šæœ¬';
	        }
	    }
	    // 2. æ›´æ–°è§¦å‘å‚æ•°æç¤º
	    function updateTriggerPlaceholder() {
	        const type = document.getElementById('triggerType').value;
	        const input = document.getElementById('triggerArgs');
	        if(type === 'interval') input.placeholder = '{"seconds": 10}';
	        else if(type === 'cron') input.placeholder = '{"hour": 14, "minute": 30}';
	        else if(type === 'date') input.placeholder = '{"run_date": "2024-05-22 14:30:00"}';
	    }
	    // 3. æ·»åŠ ä»»åŠ¡
	    async function addTask() {
	        const taskName = document.getElementById('taskName').value;
	        const funcName = document.getElementById('funcName').value;
	        const triggerType = document.getElementById('triggerType').value;
	        const triggerArgsStr = document.getElementById('triggerArgs').value;
	        if(!taskName || !funcName) {
	            alert("è¯·å¡«å†™ä»»åŠ¡åç§°å’Œé€‰æ‹©è„šæœ¬");
	            return;
	        }
	        let triggerArgs = {};
	        try {
	            if(triggerArgsStr) triggerArgs = JSON.parse(triggerArgsStr);
	        } catch(e) {
	            alert("è§¦å‘å‚æ•°ä¸æ˜¯åˆæ³•çš„ JSON");
	            return;
	        }
	        try {
	            const res = await fetch('/api/tasks', {
	                method: 'POST',
	                headers: {'Content-Type': 'application/json'},
	                body: JSON.stringify({
	                    task_name: taskName,
	                    func_name: funcName,
	                    trigger_type: triggerType,
	                    trigger_args: triggerArgs,
	                    args: [] // æš‚ä¸ä¼ å‚
	                })
	            });
	            const data = await res.json();
	            if(data.code === 0) {
	                alert("æ·»åŠ æˆåŠŸ");
	                document.getElementById('taskName').value = '';
	                loadTasks(); // åˆ·æ–°è¡¨æ ¼
	            } else {
	                alert("å¤±è´¥: " + data.message);
	            }
	        } catch(e) {
	            console.error(e);
	            alert("è¯·æ±‚å¤±è´¥");
	        }
	    }
	    // 4. åŠ è½½ä»»åŠ¡åˆ—è¡¨
	    async function loadTasks() {
	        try {
	            const res = await fetch('/api/tasks');
	            const json = await res.json();
	            const tbody = document.querySelector('#taskTable tbody');
	            tbody.innerHTML = '';
	            if(json.code === 0) {
	                json.data.forEach(job => {
	                    const tr = document.createElement('tr');
	                    tr.innerHTML = `
	                        <td>${job.id.substring(0, 12)}...</td>
	                        <td>${job.name}</td>
	                        <td style="color: green; font-weight: bold;">${job.next_run_time||'-'}</td>
	                        <td>
	                            <button class="btn btn-sm btn-success" onclick="runTask('${job.id}')">ç«‹å³æ‰§è¡Œ</button>
	                            <button class="btn btn-sm btn-danger" onclick="deleteTask('${job.id}')">åˆ é™¤</button>
	                        </td>
	                    `;
	                    tbody.appendChild(tr);
	                });
	            }
	        } catch(e) {
	            console.error(e);
	        }
	    }
	    // 5. åˆ é™¤ä»»åŠ¡
	    async function deleteTask(jobId) {
	        if(!confirm("ç¡®å®šåˆ é™¤å—?")) return;
	        await fetch(`/api/tasks/${jobId}`, {method: 'DELETE'});
	        loadTasks();
	    }
	    // 6. æ‰§è¡Œä»»åŠ¡
	    async function runTask(jobId) {
	        const res = await fetch(`/api/tasks/run/${jobId}`, {method: 'POST'});
	        const data = await res.json();
	        if(data.code === 0) alert("å·²è§¦å‘æ‰§è¡Œ");
	        else alert(data.message);
	    }
	    // é¡µé¢åŠ è½½åˆå§‹åŒ–
	    window.onload = function() {
	        loadTaskOptions(); // å…ˆåŠ è½½ä¸‹æ‹‰æ¡†
	        loadTasks();       // å†åŠ è½½è¡¨æ ¼
	        // å®šæ—¶åˆ·æ–°è¡¨æ ¼æ—¶é—´
	        setInterval(loadTasks, 5000);
	    };
	</script>
	</body>
	</html>