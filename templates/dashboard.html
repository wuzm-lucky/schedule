<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>任务调度管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: #f5f7fa;
            min-height: 100vh;
        }
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            margin-bottom: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .task-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            transition: all 0.3s;
            cursor: pointer;
            border-left: 4px solid transparent;
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .task-card.selected {
            border-left-color: #667eea;
            background: #f8f9ff;
        }
        .task-card.disabled {
            opacity: 0.6;
        }
        .task-card .task-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }
        .task-card .task-meta {
            font-size: 0.85rem;
            color: #666;
        }
        .task-card .task-stats {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }
        .stat-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .stat-success { color: #198754; }
        .stat-failed { color: #dc3545; }
        .stat-total { color: #6c757d; }
        .task-actions {
            display: flex;
            gap: 0.5rem;
        }
        .task-actions .btn {
            padding: 0.25rem 0.75rem;
            font-size: 0.85rem;
        }
        .execution-log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .execution-log .log-entry {
            margin-bottom: 0.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid #333;
        }
        .execution-log .log-entry:last-child {
            border-bottom: none;
        }
        .execution-log .log-time {
            color: #569cd6;
        }
        .execution-log .log-success {
            color: #4ec9b0;
        }
        .execution-log .log-failed {
            color: #f48771;
        }
        .execution-log .log-running {
            color: #dcdcaa;
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .search-box {
            position: relative;
            width: 250px;
        }
        .search-box input {
            padding-right: 2.5rem;
        }
        .search-box .search-icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #999;
        }
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }
        .task-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .task-toolbar-right {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
    </style>
</head>
<body>
<div class="container-fluid py-3">
    <!-- 页面头部 -->
    <div class="page-header">
        <h4 class="mb-0"><i class="bi bi-calendar-check me-2"></i>任务调度管理系统</h4>
        <small class="opacity-75">管理和监控定时任务</small>
    </div>

    <!-- 任务列表 -->
    <div class="card border-0 shadow-sm mb-3">
        <div class="card-body">
            <!-- 工具栏 -->
            <div class="task-toolbar mb-3">
                <!-- 左侧：添加任务按钮 -->
                <button class="btn btn-primary" onclick="showAddModal()">
                    <i class="bi bi-plus-lg me-1"></i>添加任务
                </button>

                <!-- 右侧：筛选、搜索、刷新 -->
                <div class="task-toolbar-right">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-secondary active" data-filter="all" onclick="setFilter('all')">
                            全部 <span class="badge bg-secondary" id="count-all">0</span>
                        </button>
                        <button type="button" class="btn btn-outline-success" data-filter="enabled" onclick="setFilter('enabled')">
                            已启用 <span class="badge bg-success" id="count-enabled">0</span>
                        </button>
                        <button type="button" class="btn btn-outline-warning" data-filter="disabled" onclick="setFilter('disabled')">
                            已暂停 <span class="badge bg-warning" id="count-disabled">0</span>
                        </button>
                    </div>
                    <div class="search-box">
                        <input type="text" class="form-control" id="searchInput" placeholder="搜索任务..." onkeyup="filterTasks()">
                        <i class="bi bi-search search-icon"></i>
                    </div>
                    <button class="btn btn-outline-secondary" onclick="loadTasks()">
                        <i class="bi bi-arrow-clockwise"></i> 刷新
                    </button>
                </div>
            </div>

            <!-- 任务列表 -->
            <div id="taskList">
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <p>暂无任务</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 执行记录 -->
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">执行记录</h6>
                <span id="selectedTaskName" class="text-muted small">请选择任务</span>
            </div>
            <div class="execution-log" id="executionLog">
                <div class="empty-state">
                    <i class="bi bi-terminal"></i>
                    <p>点击任务查看执行记录</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加任务弹窗 -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>添加新任务</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTaskForm">
                    <input type="hidden" id="editTaskId" value="">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">任务名称 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="taskName" required placeholder="输入任务名称">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">选择脚本 <span class="text-danger">*</span></label>
                            <select class="form-select" id="scriptPath" required>
                                <option value="">请选择脚本</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">触发类型 <span class="text-danger">*</span></label>
                            <select class="form-select" id="triggerType" required onchange="updateTriggerPlaceholder()">
                                <option value="interval">间隔执行</option>
                                <option value="cron">定时执行 (Cron)</option>
                                <option value="date">单次执行</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">触发参数</label>
                            <input type="text" class="form-control" id="triggerArgs" placeholder='{"seconds": 60}'>
                            <div class="form-text">
                                <small id="triggerHint">间隔: {"seconds": 60} | 定时: {"hour": 14, "minute": 30}</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">任务描述</label>
                        <textarea class="form-control" id="taskDescription" rows="2" placeholder="输入任务描述（可选）"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitTask()">
                    <i class="bi bi-check-lg me-1"></i>保存任务
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ========== 全局状态管理 ==========
const APP_STATE = {
    allTasks: [],
    currentFilter: 'all',
    selectedTaskId: null,
    runningTasks: new Set(),  // 正在运行的任务ID
    moduleLoaded: false
};

// ========== API 封装 ==========
const API = {
    async getTasks() {
        const res = await fetch('/api/tasks');
        return await res.json();
    },
    async getScripts() {
        const res = await fetch('/api/scripts');
        return await res.json();
    },
    async getTask(taskId) {
        const res = await fetch(`/api/tasks/${taskId}`);
        return await res.json();
    },
    async createTask(data) {
        const res = await fetch('/api/tasks', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        return await res.json();
    },
    async updateTask(taskId, data) {
        const res = await fetch(`/api/tasks/${taskId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        return await res.json();
    },
    async deleteTask(taskId) {
        const res = await fetch(`/api/tasks/${taskId}`, { method: 'DELETE' });
        return await res.json();
    },
    async pauseTask(taskId) {
        const res = await fetch(`/api/tasks/${taskId}/pause`, { method: 'POST' });
        return await res.json();
    },
    async resumeTask(taskId) {
        const res = await fetch(`/api/tasks/${taskId}/resume`, { method: 'POST' });
        return await res.json();
    },
    async runTask(taskId) {
        const res = await fetch(`/api/tasks/run/${taskId}`, { method: 'POST' });
        return await res.json();
    },
    async getExecutions(taskId, limit = 50) {
        const res = await fetch(`/api/tasks/${taskId}/executions?limit=${limit}`);
        return await res.json();
    }
};

// ========== 工具函数 ==========
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatTime(timeStr) {
    if (!timeStr) return '-';
    const date = new Date(timeStr);
    const now = new Date();
    const diff = now - date;
    if (diff < 60000) return '即将执行';
    if (diff < 3600000) return Math.floor(diff / 60000) + '分钟后';
    if (diff < 86400000) return Math.floor(diff / 3600000) + '小时后';
    return date.toLocaleString('zh-CN', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// ========== 任务列表渲染 ==========
function renderTasks() {
    const container = document.getElementById('taskList');
    let tasks = [...APP_STATE.allTasks];

    // 应用筛选
    if (APP_STATE.currentFilter === 'enabled') {
        tasks = tasks.filter(t => t.enabled);
    } else if (APP_STATE.currentFilter === 'disabled') {
        tasks = tasks.filter(t => !t.enabled);
    }

    // 应用搜索
    const keyword = document.getElementById('searchInput').value.toLowerCase();
    if (keyword) {
        tasks = tasks.filter(t => t.name.toLowerCase().includes(keyword));
    }

    if (tasks.length === 0) {
        container.innerHTML = `<div class="empty-state"><i class="bi bi-inbox"></i><p>暂无任务</p></div>`;
        updateCounts();
        return;
    }

    container.innerHTML = tasks.map(task => renderTaskCard(task)).join('');
    updateCounts();
}

function renderTaskCard(task) {
    const isEnabled = task.enabled;
    const isRunning = APP_STATE.runningTasks.has(task.id);
    const triggerInfo = getTriggerInfo(task);

    // 按钮渲染逻辑：
    // - 未启用: 显示编辑、启用、立即执行、删除
    // - 已启用: 显示暂停、立即执行、删除（隐藏编辑）
    // - 运行中: 禁用立即执行和删除按钮

    return `
        <div class="task-card ${!isEnabled ? 'disabled' : ''} ${APP_STATE.selectedTaskId === task.id ? 'selected' : ''}"
             onclick="selectTask('${task.id}')">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="task-name">
                        ${isEnabled ?
                            '<i class="bi bi-play-circle-fill text-success me-1"></i>' :
                            '<i class="bi bi-pause-circle text-warning me-1"></i>'}
                        ${escapeHtml(task.name)}
                    </div>
                    <div class="task-meta">
                        <span class="badge bg-secondary">${task.trigger_type}</span>
                        ${triggerInfo}
                        ${task.next_run_time ? `<span class="ms-2"><i class="bi bi-clock"></i> ${formatTime(task.next_run_time)}</span>` : ''}
                    </div>
                    <div class="task-stats">
                        <span class="stat-item stat-total">
                            <i class="bi bi-arrow-repeat"></i> ${task.run_count || 0}
                        </span>
                        <span class="stat-item stat-success">
                            <i class="bi bi-check-circle"></i> ${task.success_count || 0}
                        </span>
                        <span class="stat-item stat-failed">
                            <i class="bi bi-x-circle"></i> ${task.failed_count || 0}
                        </span>
                    </div>
                </div>
                <div class="task-actions" onclick="event.stopPropagation()">
                    ${isEnabled ?
                        `<button class="btn btn-warning btn-sm" onclick="pauseTask('${task.id}')" title="暂停">
                            <i class="bi bi-pause"></i>
                        </button>` :
                        `<button class="btn btn-success btn-sm" onclick="resumeTask('${task.id}')" title="启用">
                            <i class="bi bi-play"></i>
                        </button>`
                    }
                    ${!isEnabled ?
                        `<button class="btn btn-info btn-sm" onclick="editTask('${task.id}')" title="编辑">
                            <i class="bi bi-pencil"></i>
                        </button>` : ''
                    }
                    <button class="btn btn-primary btn-sm" onclick="runTask('${task.id}')" title="立即执行" ${isRunning ? 'disabled' : ''}>
                        <i class="bi bi-play-fill"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTask('${task.id}')" title="删除" ${isRunning ? 'disabled' : ''}>
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

function getTriggerInfo(task) {
    if (task.trigger_type === 'cron') {
        return `<code>${escapeHtml(task.cron_expression || '')}</code>`;
    } else if (task.trigger_type === 'interval') {
        return `每 ${task.interval_seconds} 秒`;
    }
    return '';
}

function updateCounts() {
    document.getElementById('count-all').textContent = APP_STATE.allTasks.length;
    document.getElementById('count-enabled').textContent = APP_STATE.allTasks.filter(t => t.enabled).length;
    document.getElementById('count-disabled').textContent = APP_STATE.allTasks.filter(t => !t.enabled).length;
}

// ========== 任务操作 ==========
function selectTask(taskId) {
    APP_STATE.selectedTaskId = taskId;
    const task = APP_STATE.allTasks.find(t => t.id === taskId);
    document.getElementById('selectedTaskName').textContent = task ? task.name : '请选择任务';
    renderTasks();
    loadExecutions(taskId);
}

function setFilter(filter) {
    APP_STATE.currentFilter = filter;
    document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === filter) btn.classList.add('active');
    });
    renderTasks();
}

function filterTasks() {
    renderTasks();
}

async function loadTasks(showLoading = true) {
    try {
        const result = await API.getTasks();
        if (result.code === 'success') {
            APP_STATE.allTasks = result.data;
            renderTasks();
        }
    } catch (e) {
        console.error('加载任务失败:', e);
    }
}

async function loadScripts() {
    try {
        const result = await API.getScripts();
        const select = document.getElementById('scriptPath');
        select.innerHTML = '<option value="">请选择脚本</option>';
        if (result.code === 'success') {
            result.data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.path;
                option.text = item.name;
                select.appendChild(option);
            });
        }
    } catch (e) {
        console.error('加载脚本失败:', e);
    }
}

function showAddModal() {
    loadScripts();
    document.getElementById('addTaskForm').reset();
    document.getElementById('editTaskId').value = '';
    document.querySelector('#addTaskModal .modal-title').innerHTML = '<i class="bi bi-plus-circle me-2"></i>添加新任务';
    new bootstrap.Modal(document.getElementById('addTaskModal')).show();
}

async function editTask(taskId) {
    const result = await API.getTask(taskId);
    if (result.code !== 'success' || !result.data) {
        alert('获取任务信息失败');
        return;
    }
    const task = result.data;
    await loadScripts();
    document.getElementById('editTaskId').value = taskId;
    document.getElementById('taskName').value = task.name;
    document.getElementById('scriptPath').value = task.script_path;
    document.getElementById('triggerType').value = task.trigger_type;
    document.getElementById('taskDescription').value = task.description || '';
    if (task.trigger_type === 'interval') {
        document.getElementById('triggerArgs').value = JSON.stringify({seconds: task.interval_seconds});
    } else if (task.trigger_type === 'cron') {
        document.getElementById('triggerArgs').value = task.cron_expression || '';
    }
    document.querySelector('#addTaskModal .modal-title').innerHTML = '<i class="bi bi-pencil me-2"></i>编辑任务';
    new bootstrap.Modal(document.getElementById('addTaskModal')).show();
}

function updateTriggerPlaceholder() {
    const type = document.getElementById('triggerType').value;
    const hint = document.getElementById('triggerHint');
    const args = document.getElementById('triggerArgs');
    if (type === 'interval') {
        args.placeholder = '{"seconds": 60}';
        hint.textContent = '间隔执行，单位：秒';
    } else if (type === 'cron') {
        args.placeholder = '{"hour": 14, "minute": 30}';
        hint.textContent = '定时执行，时:分';
    } else {
        args.placeholder = '{"run_date": "2024-12-31 14:30:00"}';
        hint.textContent = '单次执行，指定日期时间';
    }
}

async function submitTask() {
    const editId = document.getElementById('editTaskId').value;
    const name = document.getElementById('taskName').value.trim();
    const scriptPath = document.getElementById('scriptPath').value;
    const triggerType = document.getElementById('triggerType').value;
    const triggerArgsStr = document.getElementById('triggerArgs').value.trim();
    const description = document.getElementById('taskDescription').value.trim();

    if (!name || !scriptPath) {
        alert('请填写任务名称和选择脚本');
        return;
    }

    let triggerArgs = {};
    try {
        triggerArgs = triggerArgsStr ? JSON.parse(triggerArgsStr) : {};
    } catch (e) {
        alert('触发参数格式错误，请输入有效的JSON');
        return;
    }

    try {
        let result;
        if (editId) {
            // 编辑模式 - 使用正确的字段名
            result = await API.updateTask(editId, {
                name: name,
                script_path: scriptPath,
                trigger_type: triggerType,
                cron_expression: triggerType === 'cron' ? buildCronExpression(triggerArgs) : null,
                interval_seconds: triggerType === 'interval' ? (triggerArgs.seconds || 60) : null,
                scheduled_time: triggerType === 'date' ? (triggerArgs.run_date || null) : null,
                arguments: [],
                working_directory: null,
                timeout: 300,
                description: description
            });
        } else {
            // 新增模式
            result = await API.createTask({
                task_name: name,
                func_name: scriptPath,
                trigger_type: triggerType,
                trigger_args: triggerArgs,
                args: [],
                script_path: scriptPath,
                cron_expression: triggerType === 'cron' ? buildCronExpression(triggerArgs) : null,
                interval_seconds: triggerType === 'interval' ? (triggerArgs.seconds || 60) : null,
                scheduled_time: triggerType === 'date' ? (triggerArgs.run_date || null) : null,
                arguments: [],
                working_directory: null,
                timeout: 300,
                enabled: false,
                description: description
            });
        }

        if (result.code === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('addTaskModal')).hide();
            await loadTasks();
        } else {
            alert('操作失败: ' + (result.message || '未知错误'));
        }
    } catch (e) {
        console.error(e);
        alert('请求失败');
    }
}

// 从 JSON 参数构建 cron 表达式
function buildCronExpression(args) {
    if (typeof args === 'string') {
        try {
            args = JSON.parse(args);
        } catch (e) {
            // 可能已经是 cron 表达式了，验证一下
            const parts = args.trim().split(/\s+/);
            if (parts.length >= 5) {
                return args; // 已经是 cron 表达式
            }
            return '0 * * * * *'; // 默认每小时执行
        }
    }

    // 从 args 构建 cron 表达式
    // 格式: {hour: 14, minute: 30, second: 0} -> "0 30 14 * * *"
    const second = args.second || args.s || '0';
    const minute = args.minute || args.m || '0';
    const hour = args.hour || args.h || '*';
    const day = args.day || args.d || '*';
    const month = args.month || '*';
    const weekday = args.weekday || args.w || '*';

    // 简化版: 只支持 时:分 格式，如 {"hour": 14, "minute": 30}
    if (day === '*' && month === '*' && weekday === '*') {
        return `${second} ${minute} ${hour} * * *`;
    }

    return `${second} ${minute} ${hour} ${day} ${month} ${weekday}`;
}

async function pauseTask(taskId) {
    const result = await API.pauseTask(taskId);
    if (result.code === 'success') {
        await loadTasks();
    } else {
        alert('暂停失败: ' + (result.message || '未知错误'));
    }
}

async function resumeTask(taskId) {
    const result = await API.resumeTask(taskId);
    if (result.code === 'success') {
        await loadTasks();
    } else {
        alert('启用失败: ' + (result.message || '未知错误'));
    }
}

async function runTask(taskId) {
    if (!confirm('确定要立即执行此任务吗？')) return;

    // 标记为运行中
    APP_STATE.runningTasks.add(taskId);
    renderTasks();

    try {
        const result = await API.runTask(taskId);
        if (result.code === 'success') {
            if (APP_STATE.selectedTaskId === taskId) {
                setTimeout(() => loadExecutions(taskId), 1000);
            }
        } else {
            alert(result.message);
        }
    } catch (e) {
        console.error(e);
        alert('执行失败');
    } finally {
        // 延迟移除运行中状态
        setTimeout(() => {
            APP_STATE.runningTasks.delete(taskId);
            renderTasks();
        }, 2000);
    }
}

async function deleteTask(taskId) {
    if (!confirm('确定要删除此任务吗？删除后可以恢复。')) return;

    const result = await API.deleteTask(taskId);
    if (result.code === 'success') {
        await loadTasks();
        if (APP_STATE.selectedTaskId === taskId) {
            APP_STATE.selectedTaskId = null;
            document.getElementById('executionLog').innerHTML = `<div class="empty-state"><i class="bi bi-terminal"></i><p>点击任务查看执行记录</p></div>`;
            document.getElementById('selectedTaskName').textContent = '请选择任务';
        }
    } else {
        alert('删除失败');
    }
}

async function loadExecutions(taskId) {
    try {
        const result = await API.getExecutions(taskId, 50);
        const container = document.getElementById('executionLog');

        if (result.code === 'success') {
            if (result.data.length === 0) {
                container.innerHTML = `<div class="empty-state"><i class="bi bi-terminal"></i><p>暂无执行记录</p></div>`;
                return;
            }

            // 检查是否有正在运行的执行记录
            const hasRunning = result.data.some(e => e.status === 'running');
            if (hasRunning) {
                APP_STATE.runningTasks.add(taskId);
            } else {
                APP_STATE.runningTasks.delete(taskId);
            }

            container.innerHTML = result.data.map(log => {
                const statusClass = log.status === 'success' ? 'log-success' :
                                   log.status === 'failed' ? 'log-failed' : 'log-running';
                const statusIcon = log.status === 'success' ? 'check-circle' :
                                  log.status === 'failed' ? 'x-circle' : 'arrow-repeat';
                return `
                    <div class="log-entry">
                        <div>
                            <span class="log-time">${formatTime(log.start_time)}</span>
                            <span class="${statusClass}">
                                <i class="bi bi-${statusIcon}"></i> ${log.status.toUpperCase()}
                            </span>
                            ${log.duration ? `<span class="text-muted"> | 耗时 ${log.duration?.toFixed(2)}s</span>` : ''}
                        </div>
                        ${log.output ? `<div class="text-muted mt-1">${escapeHtml(log.output.substring(0, 200))}</div>` : ''}
                        ${log.error ? `<div class="text-danger mt-1">${escapeHtml(log.error.substring(0, 200))}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
    } catch (e) {
        console.error('加载执行记录失败:', e);
    }
}

// ========== 初始化 ==========
document.addEventListener('DOMContentLoaded', function() {
    loadScripts();
    loadTasks();
    // 定时刷新
    setInterval(() => {
        loadTasks(false);
        if (APP_STATE.selectedTaskId) loadExecutions(APP_STATE.selectedTaskId);
    }, 30000);
});
</script>
</body>
</html>
